> [ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘](https://github.com)**ä¸“æ -ç›´è¾¾**

MipMapæ˜¯Unityä¸­ç”¨äºä¼˜åŒ–çº¹ç†æ¸²æŸ“çš„å¤šçº§æ¸è¿œçº¹ç†æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒåŸç†æ˜¯é€šè¿‡é¢„ç”Ÿæˆä¸€ç³»åˆ—åˆ†è¾¨ç‡é€’å‡çš„çº¹ç†é‡‘å­—å¡”ï¼ˆä»åŸå§‹å°ºå¯¸é€çº§å‡åŠè‡³1Ã—1åƒç´ ï¼‰ï¼Œæ ¹æ®ç‰©ä½“ä¸æ‘„åƒæœºçš„è·ç¦»åŠ¨æ€é€‰æ‹©åˆé€‚å±‚çº§çš„çº¹ç†è¿›è¡Œé‡‡æ ·ã€‚åœ¨URPï¼ˆUniversal Render Pipelineï¼‰ä¸­ï¼Œè¯¥æŠ€æœ¯é€šè¿‡å‡å°‘è¿œå¤„ç‰©ä½“çš„çº¹ç†ç»†èŠ‚æ¥æå‡æ¸²æŸ“æ•ˆç‡ï¼ŒåŒæ—¶é¿å…å› çº¹ç†ç¼©å°å¯¼è‡´çš„æ‘©å°”çº¹å’Œé”¯é½¿ç°è±¡ã€‚

# **åŸç†è¯¦è§£**

## â€Œ**çº¹ç†é‡‘å­—å¡”æ„å»º**â€Œï¼š

* åŸå§‹çº¹ç†ç»è¿‡æ»¤æ³¢å¤„ç†ç”Ÿæˆå¤šçº§ç¼©ç•¥å›¾ï¼Œä¾‹å¦‚256Ã—256çš„çº¹ç†ä¼šç”Ÿæˆ128Ã—128ã€64Ã—64ç­‰å±‚çº§ï¼Œæ¯çº§åˆ†è¾¨ç‡é€’å‡50%ã€‚

## â€Œ**åŠ¨æ€å±‚çº§é€‰æ‹©**â€Œï¼š

* GPUæ ¹æ®åƒç´ åœ¨å±å¹•ç©ºé—´ä¸­çš„è¦†ç›–é¢ç§¯è‡ªåŠ¨è®¡ç®—åˆé€‚çš„Mipå±‚çº§ï¼ˆå…¬å¼ä¸º`level = log2(max(ddx,ddy))`ï¼Œå…¶ä¸­ddx/ddyä¸ºçº¹ç†åæ ‡å¯¼æ•°ï¼‰ã€‚

## â€Œ**è¿‡æ»¤æŠ€æœ¯é…åˆ**â€Œï¼š

* â€Œ**åŒçº¿æ€§è¿‡æ»¤**â€Œï¼šåœ¨å•ä¸€Mipå±‚çº§å†…æ’å€¼ã€‚
* â€Œ**ä¸‰çº¿æ€§è¿‡æ»¤**â€Œï¼šåœ¨ç›¸é‚»ä¸¤ä¸ªMipå±‚çº§é—´æ’å€¼ï¼Œæ¶ˆé™¤å±‚çº§åˆ‡æ¢çš„çªå…€æ„Ÿã€‚

# æ„å»º çº¹ç†é‡‘å­—å¡”

åœ¨Unity URPä¸­ï¼ŒMipmapçº¹ç†é‡‘å­—å¡”çš„æ„å»ºæ˜¯é€šè¿‡GPUé€çº§ä¸‹é‡‡æ ·å®ç°çš„ï¼Œå…¶æ ¸å¿ƒæµç¨‹åˆ†ä¸ºç¡¬ä»¶è‡ªåŠ¨ç”Ÿæˆå’Œè®¡ç®—ç€è‰²å™¨æ‰‹åŠ¨ç”Ÿæˆä¸¤ç§æ–¹å¼ã€‚

## **ç¡¬ä»¶è‡ªåŠ¨ç”ŸæˆåŸç†**

* â€Œ**åŸºç¡€çº¹ç†å¤„ç†**â€Œï¼šåŸå§‹çº¹ç†ï¼ˆå¦‚2048Ã—2048ï¼‰ç»è¿‡åŒçº¿æ€§/ä¸‰çº¿æ€§æ»¤æ³¢å¤„ç†ï¼Œç”Ÿæˆåˆ†è¾¨ç‡é€çº§å‡åŠçš„å­çº¹ç†ï¼ˆ1024Ã—1024ã€512Ã—512ç­‰ï¼‰ï¼Œç›´è‡³1Ã—1åƒç´ ã€‚
* â€Œ**å±‚çº§å…³ç³»è®¡ç®—**â€Œï¼šGPUæ ¹æ®å±å¹•åƒç´ è¦†ç›–ç‡è‡ªåŠ¨é€‰æ‹©Mipå±‚çº§ï¼Œå…¬å¼ä¸ºï¼š$lod=log2(max(\frac{\partial u}{\partial x},\frac{\partial v}{\partial y}))$å…¶ä¸­åå¯¼æ•°é€šè¿‡çº¹ç†åæ ‡å¾®åˆ†è®¡ç®—ã€‚

## **è®¡ç®—ç€è‰²å™¨æ‰‹åŠ¨ç”Ÿæˆç¤ºä¾‹ï¼ˆHi-ZæŠ€æœ¯ï¼‰**

* é€šè¿‡Compute Shaderæ„å»ºæ·±åº¦çº¹ç†çš„é‡‘å­—å¡”ï¼š
  + HiZFeature.cs

    ```
    |  |  |
    | --- | --- |
    |  | using UnityEngine; |
    |  | using UnityEngine.Rendering; |
    |  | using UnityEngine.Rendering.Universal; |
    |  |  |
    |  | public class HiZFeature : ScriptableRendererFeature { |
    |  | class HiZPass : ScriptableRenderPass { |
    |  | ComputeShader _hizShader; |
    |  | RenderTexture _hizPyramid; |
    |  |  |
    |  | public override void Execute(ScriptableRenderContext context, ref RenderingData data) { |
    |  | CommandBuffer cmd = CommandBufferPool.Get(); |
    |  | // ä»æ·±åº¦çº¹ç†ç”ŸæˆMipmapé‡‘å­—å¡” |
    |  | int width = _hizPyramid.width; |
    |  | int height = _hizPyramid.height; |
    |  | for (int mip = 0; width >= 8 || height >= 8; mip++) { |
    |  | cmd.SetComputeTextureParam(_hizShader, 0, "_HiZTexture", _hizPyramid, mip); |
    |  | cmd.DispatchCompute(_hizShader, 0, width/8, height/8, 1); |
    |  | width >>= 1; height >>= 1; |
    |  | } |
    |  | context.ExecuteCommandBuffer(cmd); |
    |  | CommandBufferPool.Release(cmd); |
    |  | } |
    |  | } |
    |  | } |
    ```
  + HiZ.compute

    ```
    |  |  |
    | --- | --- |
    |  | #pragma kernel CSMain_HiZ |
    |  | Texture2D<float> _DepthTexture; |
    |  | RWTexture2D<float> _HiZTexture; |
    |  |  |
    |  | [numthreads(8, 8, 1)] |
    |  | void CSMain_HiZ(uint3 id : SV_DispatchThreadID) { |
    |  | // 8x8åŒºåŸŸå–æœ€å¤§æ·±åº¦å€¼ä½œä¸ºä¸‹é‡‡æ ·ç»“æœ |
    |  | float maxDepth = 0; |
    |  | for (int x = 0; x < 8; x++) { |
    |  | for (int y = 0; y < 8; y++) { |
    |  | maxDepth = max(maxDepth, _DepthTexture[id.xy * 8 + uint2(x,y)]); |
    |  | } |
    |  | } |
    |  | _HiZTexture[id.xy] = maxDepth; |
    |  | } |
    ```

### **å…³é”®æ­¥éª¤è§£æ**

* â€Œ**å±‚çº§ç”Ÿæˆé€»è¾‘**â€Œï¼šæ¯çº§Mipmapé€šè¿‡å¯¹ä¸Šä¸€çº§4ä¸ªåƒç´ å–å¹³å‡å€¼ï¼ˆé¢œè‰²çº¹ç†ï¼‰æˆ–æœ€å¤§å€¼ï¼ˆæ·±åº¦çº¹ç†ï¼‰ç”Ÿæˆï¼Œä¾‹å¦‚256Ã—256çº¹ç†ç”Ÿæˆ128Ã—128å±‚çº§æ—¶ï¼Œæ¯ä¸ªæ–°åƒç´ ç”±åŸçº¹ç†2Ã—2åŒºåŸŸè®¡ç®—å¾—å‡ºã€‚
* â€Œ**è¿‡æ»¤æ¨¡å¼å½±å“**â€Œï¼š
  + â€Œ**åŒçº¿æ€§è¿‡æ»¤**â€Œï¼šåœ¨å•å±‚Mipå†…æ’å€¼4ä¸ªç›¸é‚»çº¹ç´ ã€‚
  + â€Œ**ä¸‰çº¿æ€§è¿‡æ»¤**â€Œï¼šåœ¨ç›¸é‚»ä¸¤å±‚Mipé—´è¿›è¡ŒäºŒæ¬¡æ’å€¼ï¼Œæ¶ˆé™¤å±‚çº§åˆ‡æ¢çªå˜ã€‚

## **åº”ç”¨åœºæ™¯å¯¹æ¯”**

| ç”Ÿæˆæ–¹å¼ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½å¼€é”€ |
| --- | --- | --- |
| ç¡¬ä»¶è‡ªåŠ¨ç”Ÿæˆ | å¸¸è§„é¢œè‰²çº¹ç† | ä½ |
| è®¡ç®—ç€è‰²å™¨ç”Ÿæˆ | æ·±åº¦çº¹ç†/ç‰¹æ®Šæ•ˆæœï¼ˆå¦‚Hi-Zï¼‰ | ä¸­é«˜ |

é€šè¿‡è°ƒæ•´`RenderTexture.useMipMap`å±æ€§å’Œ`GenerateMipMaps`æ ‡å¿—ä½å¯æ§åˆ¶ç”Ÿæˆè¡Œä¸ºã€‚æ‰‹åŠ¨ç”Ÿæˆæ›´é€‚åˆéœ€è¦è‡ªå®šä¹‰ä¸‹é‡‡æ ·è§„åˆ™çš„åœºæ™¯ï¼Œå¦‚é®æŒ¡å‰”é™¤ä¼˜åŒ–.

# å®ç°åŠ¨æ€å±‚çº§é€‰æ‹©

åœ¨Unity URPä¸­ï¼ŒMipmapçš„åŠ¨æ€å±‚çº§é€‰æ‹©æ˜¯é€šè¿‡GPUç¡¬ä»¶è‡ªåŠ¨è®¡ç®—çº¹ç†åæ ‡çš„å¯¼æ•°ï¼ˆddx/ddyï¼‰å®ç°çš„.

## **åŠ¨æ€é€‰æ‹©åŸç†**

* â€Œ**å¯¼æ•°è®¡ç®—**â€Œ$lod=log2(max(âˆ¥\frac{\partial u}{\partial x}âˆ¥,âˆ¥\frac{\partial v}{\partial y}âˆ¥))$

  GPUé€šè¿‡ç‰‡å…ƒç€è‰²å™¨ä¸­çš„çº¹ç†åæ ‡åå¯¼æ•°ï¼ˆ`ddx(uv)`å’Œ`ddy(uv)`ï¼‰ç¡®å®šå±å¹•åƒç´ è¦†ç›–çš„çº¹ç†åŒºåŸŸå¤§å°ã€‚å½“ç‰©ä½“è·ç¦»æ‘„åƒæœºè¶Šè¿œï¼ŒUVåæ ‡å˜åŒ–ç‡è¶Šå¤§ï¼Œå¯¼æ•°å€¼è¶Šé«˜ã€‚

  *ç¤ºä¾‹*ï¼šè‹¥å±å¹•åƒç´ è¦†ç›–4Ã—4çº¹ç´ åŒºåŸŸï¼Œåˆ™Mipå±‚çº§è®¡ç®—å…¬å¼ä¸ºï¼š

  æ­¤æ—¶è®¡ç®—ç»“æœä¸º2ï¼ˆå› 4=2Â²ï¼‰ï¼Œé€‰æ‹©Mip Level 2çš„çº¹ç†ã€‚
* â€Œ**å±‚çº§æ’å€¼**â€Œ

  å¯ç”¨ä¸‰çº¿æ€§è¿‡æ»¤æ—¶ï¼ŒGPUä¼šåœ¨è®¡ç®—å‡ºçš„å±‚çº§ï¼ˆå¦‚2.3çº§ï¼‰ç›¸é‚»ä¸¤å±‚ï¼ˆLevel 2å’ŒLevel 3ï¼‰ä¹‹é—´è¿›è¡Œæ’å€¼ï¼Œæ¶ˆé™¤çªå˜æ„Ÿã€‚
* â€Œ**LODåç§»æ§åˆ¶**â€Œ

  URPé€šè¿‡`Texture2D.mipMapBias`å‚æ•°æ‰‹åŠ¨è°ƒæ•´å±‚çº§åç§»ï¼Œæ­£å€¼ä½¿çº¹ç†æ›´æ¨¡ç³Šï¼ˆå¼ºåˆ¶ä½¿ç”¨æ›´é«˜å±‚çº§ï¼‰ï¼Œè´Ÿå€¼ä¿ç•™ç»†èŠ‚ï¼ˆåå‘ä½çº§ï¼‰ã€‚

## **å®ç°ç¤ºä¾‹**

ä»¥ä¸‹Shaderä»£ç æ¼”ç¤ºæ‰‹åŠ¨æ§åˆ¶Mipå±‚çº§çš„ä¸¤ç§æ–¹å¼ï¼š

```
|  |  |
| --- | --- |
|  | hlsl |
|  | // æ–¹å¼1ï¼šé€šè¿‡tex2Dlodç¡¬ç¼–ç å±‚çº§ |
|  | fixed4 frag(v2f i) : SV_Target { |
|  | float4 uv = float4(i.uv, 0, _ManualLod); // _ManualLodä¸ºè‡ªå®šä¹‰å±‚çº§ |
|  | return tex2Dlod(_MainTex, uv); |
|  | } |
|  |  |
|  | // æ–¹å¼2ï¼šæ ¹æ®è·ç¦»åŠ¨æ€è®¡ç®—å±‚çº§ |
|  | float3 worldPos = mul(unity_ObjectToWorld, v.vertex).xyz; |
|  | float dist = distance(_WorldSpaceCameraPos, worldPos); |
|  | float lod = log2(dist * _LodScale); // _LodScaleæ§åˆ¶è·ç¦»æ•æ„Ÿåº¦ |
|  | fixed4 col = tex2Dlod(_MainTex, float4(i.uv, 0, lod)); |
```

## **å±‚çº§é€‰æ‹©ä¼˜åŒ–**

* â€Œ**Hi-ZæŠ€æœ¯**â€Œ

  å¯¹æ·±åº¦çº¹ç†æ„å»ºMipé‡‘å­—å¡”æ—¶ï¼Œæ¯å±‚çº§å­˜å‚¨æœ€å¤§æ·±åº¦å€¼ï¼ˆè€Œéé¢œè‰²å¹³å‡å€¼ï¼‰ï¼ŒåŠ é€Ÿé®æŒ¡å‰”é™¤ã€‚

  *æµç¨‹*ï¼š

  + ç”Ÿæˆæ·±åº¦çº¹ç†Mipmapæ—¶ï¼Œé€šè¿‡Compute Shaderå¯¹4Ã—4åŒºåŸŸå–æœ€å¤§å€¼ä¸‹é‡‡æ ·ã€‚
  + æ¸²æŸ“æ—¶æ ¹æ®å±‚çº§æ·±åº¦å¿«é€Ÿåˆ¤æ–­å¯è§æ€§ã€‚
* â€Œ**ShaderGraphèŠ‚ç‚¹**â€Œ

  URPçš„`Calculate Level Of Detail`èŠ‚ç‚¹æä¾›ä¸¤ç§æ¨¡å¼ï¼š

  + â€Œ**Clamped**â€Œï¼šé™åˆ¶åœ¨çº¹ç†æœ€å¤§å±‚çº§å†…ï¼Œé¿å…è¶Šç•Œã€‚
  + â€Œ**Unclamped**â€Œï¼šå…è®¸è¶…å‡ºç°æœ‰å±‚çº§ï¼Œéœ€é…åˆè¾¹ç•Œå¤„ç†ã€‚

## **æ€§èƒ½ä¸è´¨é‡å¹³è¡¡**

* â€Œ**è¿‡æ¨¡ç³Šé—®é¢˜**â€Œï¼šé€šè¿‡`QualitySettings.masterTextureLimit`å…¨å±€é™åˆ¶æœ€é«˜å±‚çº§ã€‚
* â€Œ**é”åŒ–éœ€æ±‚**â€Œï¼šç¦ç”¨Mipmapæˆ–ä½¿ç”¨`Unlit` Shaderé¿å…è‡ªåŠ¨æ’å€¼ã€‚

å…¸å‹åº”ç”¨åœºæ™¯åŒ…æ‹¬åœ°å½¢æ¸²æŸ“ï¼ˆè¿œå±±ä½¿ç”¨é«˜Mipå±‚çº§ï¼‰å’ŒåŠ¨æ€LODç³»ç»Ÿï¼ˆæ ¹æ®ç‰©ä½“é‡è¦æ€§è°ƒæ•´`mipMapBias`ï¼‰

# **è§£å†³çš„é—®é¢˜**

## â€Œ**æ€§èƒ½ä¼˜åŒ–**â€Œï¼š

* å‡å°‘æ˜¾å­˜å¸¦å®½å ç”¨ï¼Œè¿œå¤„ç‰©ä½“ä½¿ç”¨ä½åˆ†è¾¨ç‡çº¹ç†é™ä½GPUè´Ÿè½½ã€‚

## â€Œ**è§†è§‰è´¨é‡**â€Œï¼š

* æ¶ˆé™¤è¿œæ™¯çš„åƒç´ é—ªçƒï¼ˆTexture Aliasingï¼‰å’Œé”¯é½¿ï¼Œæå‡å¹³æ»‘åº¦ã€‚

## â€Œ**ç¼“å­˜å‘½ä¸­ç‡**â€Œï¼š

* ä½åˆ†è¾¨ç‡çº¹ç†å ç”¨æ›´å°‘ç¼“å­˜ç©ºé—´ï¼Œæé«˜é‡‡æ ·æ•ˆç‡ã€‚

# **ä½¿ç”¨åœºæ™¯ä¸é™åˆ¶**

* â€Œ**é€‚ç”¨åœºæ™¯**â€Œï¼š
  + 3Då¼€æ”¾ä¸–ç•Œåœ°å½¢ï¼ˆå¦‚è¿œå±±ã€å»ºç­‘ï¼‰ã€‚
  + åŠ¨æ€ç¼©æ”¾çš„ç‰©ä½“ï¼ˆå¦‚è§’è‰²æ¨¡å‹åœ¨è¿œè·ç¦»æ—¶ï¼‰ã€‚
* â€Œ**ä¸é€‚ç”¨åœºæ™¯**â€Œï¼š
  + 2Dåƒç´ æ¸¸æˆï¼ˆéœ€ä¿æŒé”åˆ©åƒç´ é£æ ¼ï¼‰ã€‚
  + UIå…ƒç´ ï¼ˆé€šå¸¸æ— éœ€åŠ¨æ€ç¼©æ”¾ï¼‰ã€‚
* â€Œ**é™åˆ¶**â€Œï¼š
  + å†…å­˜å¼€é”€å¢åŠ 33%ï¼ˆå­˜å‚¨å¤šçº§çº¹ç†ï¼‰ã€‚
  + å¯èƒ½å¼•èµ·è¿œå¤„çº¹ç†è¿‡åº¦æ¨¡ç³Šï¼ˆéœ€è°ƒæ•´Mip Biaså‚æ•°ï¼‰ã€‚

# **å…·ä½“ç¤ºä¾‹**

* â€Œ**Shaderå®ç°**â€Œï¼š

  åœ¨URP Shaderä¸­ï¼Œå¯é€šè¿‡`tex2Dlod`å‡½æ•°æ‰‹åŠ¨æŒ‡å®šMipå±‚çº§ï¼ˆ`float4`å‚æ•°çš„wåˆ†é‡æ§åˆ¶å±‚çº§ï¼‰ã€‚ä¾‹å¦‚ï¼š

  ```
  |  |  |
  | --- | --- |
  |  | hlsl |
  |  | fixed4 frag(v2f i) : SV_Target { |
  |  | return tex2Dlod(_MainTex, float4(i.uv, 0, _MipLevel)); |
  |  | } |
  ```

  è°ƒæ•´`_MipLevel`å¯è§‚å¯Ÿä¸åŒå±‚çº§çš„æ¨¡ç³Šæ•ˆæœ.
* â€Œ**Unityç¼–è¾‘å™¨æ¼”ç¤º**â€Œï¼š

  + å¯¼å…¥çº¹ç†åå‹¾é€‰`Generate Mip Maps`ï¼Œè§‚å¯ŸInspectoré¢æ¿ä¸­çš„Mipmapé¢„è§ˆæ»‘å—ï¼ˆ0-10çº§ï¼‰ã€‚
  + å¯¹æ¯”å¼€å¯/å…³é—­Mipmapçš„ç›¸åŒçº¹ç†ï¼Œè¿œå¤„ç‰©ä½“åœ¨å¼€å¯æ—¶ä¼šè‡ªç„¶æ¨¡ç³Šï¼Œå…³é—­åˆ™å‡ºç°åƒç´ å™ªç‚¹ã€‚

é€šè¿‡æƒè¡¡å†…å­˜ä¸æ€§èƒ½ï¼ŒMipmapåœ¨URPä¸­æˆä¸ºä¼˜åŒ–å¤§è§„æ¨¡åœºæ™¯æ¸²æŸ“çš„å…³é”®æŠ€æœ¯ä¹‹ä¸€

---

> [ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘](https://github.com):[é€—çŒ«æœºåœº](https://doucat6.com)**ä¸“æ -ç›´è¾¾**
> ï¼ˆæ¬¢è¿*ç‚¹èµç•™è¨€*æ¢è®¨ï¼Œæ›´å¤šäººåŠ å…¥è¿›æ¥èƒ½æ›´åŠ å®Œå–„è¿™ä¸ªæ¢ç´¢çš„è¿‡ç¨‹ï¼ŒğŸ™ï¼‰
